<!DOCTYPE html>
<html lang="en" 
      xmlns="http://www.w3.org/1999/xhtml"  
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <!-- Meta, title, CSS, favicons, etc. -->
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

        <title>Users </title>

        <!-- Bootstrap -->
        <link th:href="@{/vendors/bootstrap/dist/css/bootstrap.min.css}" rel="stylesheet"/>
        <!-- Font Awesome -->
        <link th:href="@{/vendors/font-awesome/css/font-awesome.min.css}" rel="stylesheet"/>
        <!-- NProgress -->
        <link th:href="@{/vendors/nprogress/nprogress.css}" rel="stylesheet"/>

        <!-- bootstrap-daterangepicker -->
        <link th:href="@{/vendors/bootstrap-daterangepicker/daterangepicker.css}" rel="stylesheet"/>
        <!-- bootstrap-datetimepicker -->
        <link th:href="@{/vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css}" rel="stylesheet"/>
        <!--Select2-->
        <link th:href="@{/vendors/select2/css/select2.css}" rel="stylesheet"/>
        <!-- iCheck -->
        <link th:href="@{/vendors/iCheck/skins/flat/green.css}" rel="stylesheet"/>

        <!-- Custom Theme Style -->
        <link th:href="@{/build/css/custom.css}" rel="stylesheet"/>

    </head>

    <body class="nav-md">
        <div class="container body">
            <div class="main_container" id="main_container">

                <div th:insert="fragments/sidebar.html :: sidebar"> </div>
                <!-- insert sidebar here -->

                <!-- Insert topbar here -->
                <div th:insert="fragments/topbar.html :: topbar"> </div>

                <!-- page content -->
                <div class="right_col" role="main">
                    <div class="">
                        <div class="page-title">
                            <div class="title_left">
                                <h3>Users</h3> 

                            </div>

                            <div class="title_right">
                                <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
                                    <form action="#" th:action="@{'/users/search}" th:object="${searchForm}" method="post">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{value}" placeholder="Search for..."/>
                                            <span class="input-group-btn">
                                                <button class="btn btn-primary" type="submit"><i class="fa fa-search" aria-hidden="true"></i></button>
                                            </span>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="clearfix"></div>

                        <div class="row">

                            <div class="clearfix"></div>

                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_title">


                                        <div class="btn-toolbar justify-content-between">
                                            <div class="btn-group">
                                                <button data-toggle="dropdown" class="btn btn-default dropdown-toggle" type="button" aria-expanded="false">
                                                    <span th:text="${pageCount}" style="color: black"></span>
                                                    <span class="caret"></span>
                                                </button>

                                                <button id="reportrange" class="btn btn-default dropdown-toggle" type="button">
                                                    <i class="fa fa-calendar"></i>&nbsp;
                                                    <span></span> <i class="fa fa-caret-down"></i>

                                                </button>
                                                <ul role="menu" class="dropdown-menu">
                                                    <!-- /users/paginated/1?count=10 -->
                                                    <li>
                                                        <a th:href="@{'/users?count=10'}">10</a>
                                                    </li>
                                                    <li>
                                                        <a th:href="@{'/users?count=20'}">20</a>
                                                    </li>
                                                    <li>
                                                        <a th:href="@{'/users?count=50'}">50</a>
                                                    </li>
                                                    <li>
                                                        <a th:href="@{'/users?count=100'}">100</a>
                                                    </li>
                                                    <li>
                                                        <a th:href="@{'/users?count=500'}">500</a>
                                                    </li>
                                                    <li>
                                                        <a th:href="@{'/users?count=1000'}">1000</a>
                                                    </li>
                                                </ul>
                                            </div>



                                            <div class="btn-group pull-right">
                                                <a id="new-btn" class="btn btn-default" type="button">New</a>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <div class="x_content">
                                        <div class="table-responsive">
                                            <table class="table table-striped jambo_table bulk_action">
                                                <thead>
                                                    <tr class="headings">
                                                        <th class="column-title">Username </th>
                                                        <th class="column-title">First name </th>
                                                        <th class="column-title">Last Name</th>
                                                        <th class="column-title">Email</th>
                                                        <th class="column-title">Phone </th>
                                                        <th class="column-title">Action </th>
                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    <tr class="even pointer"  th:if="${#lists.isEmpty(users)}">
                                                        <td class="a-center " colspan="6">
                                                            No User available
                                                        </td>
                                                    </tr>
                                                    <tr th:each="user : ${users}" class="odd pointer">
                                                        <td class=" ">
                                                            <span th:text="${user.username}"/>
                                                        </td>
                                                        <td class=" ">
                                                            <span th:text="${user.principals.get('firstname')}"/>
                                                        </td>
                                                        <td class=" ">
                                                            <span th:text="${user.principals.get('lastname')}"/>
                                                        </td>
                                                        <td class=" ">
                                                            <span th:text="${user.principals.get('email')}"/>
                                                        </td>
                                                        <td class=" ">
                                                            <span th:text="${user.principals.get('phone')}"/>
                                                        </td>

                                                        <td class=" ">
                                                            <a href="#" th:url="${user.links.get('profile')}" 
                                                               onclick= "fetchProfile(this.getAttribute('url'));">More</a>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>


                                    </div>
                                    <div class="x_footer">
                                        <div class="btn-toolbar">
                                            <div class="btn-group"  th:if="${!isFirstPage}">
                                                <a class="btn btn-default" 
                                                   th:href="@{'/users?page=1'}">
                                                    |<
                                                </a>
                                            </div>
                                            <div class="btn-group" th:each="page: ${pagination}">
                                                <a class="btn btn-default" th:classappend="${page.active}" 
                                                   th:href="@{'/users?page=' + ${page.pageNo}}">
                                                    <span th:text="${page.pageNo}"></span>
                                                </a>
                                            </div>
                                            <div class="btn-group" th:if="${!isLastPage}">
                                                <a class="btn btn-default" 
                                                   th:href="@{'/users?page='+ ${lastPage}}">
                                                    >|
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <div th:insert="fragments/create-user.html :: create-user-dialog"> </div>
            <!-- /page content -->

            <!-- Insert footer here -->
            <div th:insert="fragments/footer.html :: footer"> </div>
        </div>

        <!-- jQuery -->
        <script th:src="@{/vendors/jquery/dist/jquery.min.js}"></script>
        <!-- Bootstrap -->
        <script th:src="@{/vendors/bootstrap/dist/js/bootstrap.min.js}"></script>
        <!-- FastClick -->
        <script th:src="@{/vendors/fastclick/lib/fastclick.js}"></script>
        <!-- NProgress -->
        <script th:src="@{/vendors/nprogress/nprogress.js}"></script>

        <!-- bootstrap-daterangepicker -->
        <script th:src="@{/vendors/moment/min/moment.min.js}"></script>
        <script th:src="@{/vendors/bootstrap-daterangepicker/daterangepicker.js}"></script>
        <!-- bootstrap-datetimepicker -->    
        <script th:src="@{/vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js}"></script>
        <!--Select2-->
        <script th:src="@{/vendors/select2/js/select2.js}" rel="stylesheet"/>
        <!-- iCheck -->
        <script th:src="@{/vendors/iCheck/icheck.min.js}"></script>

        <!-- Custom Theme Scripts -->
        <script th:src="@{/build/js/custom.js}"></script>

        <a style="display: none" id="hiddenLink" th:href="@{/users}"></a>

        <script  th:inline="javascript">
            /*<![CDATA[*/

            var from = /*[[${from}]]*/ "";
            var to = /*[[${to}]]*/ "";
            var msg = /*[[${messages}]]*/ [];




            var showProfile = function (response) {
                $('#main_container').append(response);

                var userProfileModal = $('#user-profile-dialog');


                $('.close-profile-btn').click(function () {
                    userProfileModal.modal("hide");
                });
                userProfileModal.on('hidden.bs.modal', function (e) {
                    userProfileModal.remove();
                });


                userProfileModal.on('show.bs.modal', function () {
                    $('#user-profile-body').css({
                        width: 'auto', //probably not needed
                        height: 'auto', //probably not needed 
                        'max-width': '100%'
                    });
                });

                userProfileModal.modal("show");
            };

            var fetchProfile = function (url) {
                $.get(url, showProfile).fail(function () {
                    alert("error");
                });
            };

            $(document).ready(function () {
                if (msg) {
                    for (i in msg) {
                        new PNotify(msg[i]);
                    }
                }

                $(window).keydown(function (event) {
                    if (event.keyCode === 13) {
                        event.preventDefault();
                        return false;
                    }
                });

                $('.select2-basic-multiple').select2();

                var createUserModal = $('#create-user-dialog');

                $('#save-create-btn').click(function () {
                    createUserModal.modal("hide");
                    $('#create-user-form').submit();
                });

                $('.cancel-create-btn').click(function () {
                    createUserModal.modal("hide");
                });

                $('#new-btn').click(function (event) {
                    event.preventDefault();
                    createUserModal.modal("show");
                });

                var start = moment(from, 'DD/MM/YYYY hh:mm A');
                var end = moment(to, 'DD/MM/YYYY hh:mm A');

                if (end === null || start === null) {
                    end = moment();
                    start = moment().subtract(365, 'days');
                }


                function cb(start, end) {

                    $('#reportrange span').html(start.format('D MMMM, YYYY hh:mm A') + ' - ' + end.format('D MMMM, YYYY hh:mm A'));

                }

                $('#reportrange').daterangepicker({
                    timePicker: true,
                    linkedCalendars: false,
                    startDate: start,
                    endDate: end,
                    ranges: {
                        'Today': [moment(), moment()],
                        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                        'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                        'This Month': [moment().startOf('month'), moment().endOf('month')],
                        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    }
                }, cb).on('apply.daterangepicker', function (ev, picker) {
                    var url = $("#hiddenLink").attr('href');
                    console.log(picker.startDate.format('YYYY-MM-DD'));
                    console.log(picker.endDate.format('YYYY-MM-DD'));
                    var href = url + '?f=' + picker.startDate.format("DD/MM/YYYY hh:mm a") + '&t=' + picker.endDate.format("DD/MM/YYYY hh:mm a");
                    console.log(href);
                    window.location.href = href;
                });
                cb(start, end);


            });

            var query = window.location.search.substring(1);
            if (query.length) {
                if (window.history !== undefined && window.history.pushState !== undefined) {
                    window.history.pushState({}, document.title, window.location.pathname);
                }
            }
        </script>
    </body>

</html>